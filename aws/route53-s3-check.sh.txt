AWS_PROFILES="riotweb rcloud riotwebtest"

(
    if [ ! -d aws_result_cache ]; then
	mkdir aws_result_cache
    fi

    cd aws_result_cache 

    for AWS_PROFILE in $AWS_PROFILES; do
	AWS_RECORD_JSON_FILE=$AWS_PROFILE-zone_ids.txt
	if [ ! -f $AWS_RECORD_JSON_FILE ]; then
	    echo "Listing zones from profile $AWS_PROFILE"
	    aws --profile $AWS_PROFILE route53 list-hosted-zones | jq -r '.HostedZones[].Id | ltrimstr("/hostedzone/")' > $AWS_RECORD_JSON_FILE
	fi

	for ZONE_ID in $(cat $AWS_RECORD_JSON_FILE); do
	    S3_DOMAINS_JSON_FILE=$ZONE_ID-s3_domains.txt

	    if [ ! -f $S3_DOMAINS_JSON_FILE ]; then
		echo "    Scanning $ZONE_ID..."
		aws --profile $AWS_PROFILE route53 list-resource-record-sets --hosted-zone-id $ZONE_ID > $ZONE_ID-record-sets.json
		jq -r '.ResourceRecordSets[] | select(.ResourceRecords[].Value | contains("amazonaws.com") and contains("s3")) | .Name' < $ZONE_ID-record-sets.json > $S3_DOMAINS_JSON_FILE
	    fi
	done

	S3_BUCKET_LIST_FILE=$AWS_PROFILE-s3_bucket-list.txt
	if [ ! -f $S3_BUCKET_LIST_FILE ]; then
	    aws --profile $AWS_PROFILE s3 ls | awk '{print $3;}' > $S3_BUCKET_LIST_FILE
	fi
    done

    cat *-s3_domains.txt *-s3_bucket-list.txt | sed 's/\.$//' | sort | uniq -d > matched_buckets_with_domains.txt
    cat matched_buckets_with_domains.txt *-s3_domains.txt | sed 's/\.$//' | sort | uniq -u
)
